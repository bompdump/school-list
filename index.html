<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>砖转 转 住驻专</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="砖转 转 住驻专">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/000000/FFFFFF?text=PWA">
    <link rel="apple-touch-startup-image" href="https://placehold.co/1125x2436/000000/FFFFFF?text=Loading">

    <link rel="manifest" href="/your-repo-name/manifest.json">
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6 text-center">
            砖转 转 住驻专
        </h1>

        <div id="userIdDisplay" class="text-sm text-gray-600 mb-4 text-center break-all">
            </div>

        <button id="requestNotificationPermissionBtn"
            class="w-full py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 mb-4
            bg-gray-400 hover:bg-gray-500 text-white font-bold">
            驻注 转专转
        </button>

        <div class="flex flex-col gap-3 mb-6">
            <input type="text" id="newTaskInput"
                class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-gray-800"
                placeholder="转专 砖..." />
            <input type="text" id="newSubjectInput"
                class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-gray-800"
                placeholder="拽爪注 (: 转拽)" />
            
            <label for="newDoDateInput" class="text-sm text-gray-700 -mb-2">转 注砖转 (转专):</label>
            <input type="date" id="newDoDateInput"
                class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-gray-800" />
            
            <label for="newDoTimeInput" class="text-sm text-gray-700 -mb-2">转 注砖转 (砖注):</label>
            <input type="time" id="newDoTimeInput"
                class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-gray-800" />

            <label for="newSubmissionDateInput" class="text-sm text-gray-700 -mb-2">转 爪专 砖:</label>
            <input type="date" id="newSubmissionDateInput"
                class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-gray-800" />
            
            <button id="addTaskBtn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                住祝 砖
            </button>
        </div>

        <ul id="taskList" class="space-y-4">
            </ul>
        <p id="noTasksMessage" class="text-center text-gray-500 text-lg mt-4 hidden"> 砖转 专注!</p>
    </div>

    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and application state
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        let notificationPermission = "default"; // Initial state for notification permission
        const NOTIFICATION_LAST_SENT_KEY = 'lastNotificationDate'; // Key for localStorage to prevent daily spamming of notifications

        // Get DOM elements for interaction
        const newTaskInput = document.getElementById('newTaskInput');
        const newSubjectInput = document.getElementById('newSubjectInput');
        const newDoDateInput = document.getElementById('newDoDateInput'); // New input for "When to do" date
        const newDoTimeInput = document.getElementById('newDoTimeInput'); // New input for "When to do" time
        const newSubmissionDateInput = document.getElementById('newSubmissionDateInput'); // Renamed from newDueDateInput
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskList = document.getElementById('taskList');
        const noTasksMessage = document.getElementById('noTasksMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const requestNotificationPermissionBtn = document.getElementById('requestNotificationPermissionBtn');

        /**
         * Initializes Firebase application and authentication.
         * Sets up an authentication state listener to handle user sign-in.
         */
        async function initializeFirebase() {
            try {
                // Retrieve app ID and Firebase config from global variables provided by the environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                console.log("Firebase Init: Starting initialization...");
                console.log("Firebase Config:", firebaseConfig);
                console.log("App ID:", appId);

                // Check if Firebase config is valid
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or empty. Please ensure __firebase_config is correctly set.");
                    return;
                }

                // Initialize Firebase app, Firestore, and Auth services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase Init: App, DB, Auth initialized.");

                // Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth State Changed. User:", user);
                    if (!user) {
                        // If no user is authenticated, try to sign in
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                console.log("Auth State Changed: Signing in with custom token.");
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                console.log("Auth State Changed: Signing in anonymously.");
                                await signInAnonymously(auth);
                            }
                            console.log("Auth State Changed: Sign-in attempt completed.");
                        } catch (error) {
                            console.error("Error during Firebase sign-in:", error);
                        }
                    }
                    // Set current user ID, either from authenticated user or a random UUID for anonymous
                    currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                    userIdDisplay.innerHTML = ` 砖转砖: <span class="font-mono bg-gray-100 p-1 rounded">${currentUserId}</span>`;
                    isAuthReady = true; // Mark authentication as ready
                    console.log("Auth State Changed: currentUserId set to", currentUserId, "isAuthReady:", isAuthReady);

                    // Once authentication is ready, start listening for tasks from Firestore
                    listenForTasks();
                    // Attach event listeners for adding tasks AFTER Firebase is ready
                    setupAddTaskListeners();
                });

                // Check initial notification permission status
                if ("Notification" in window) {
                    notificationPermission = Notification.permission;
                    updateNotificationButtonState(); // Update the UI button based on permission
                }

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
            }
        }

        /**
         * Sets up event listeners for adding tasks.
         * This function is called only after Firebase authentication is ready.
         */
        function setupAddTaskListeners() {
            console.log("setupAddTaskListeners: Attaching event listeners.");
            addTaskBtn.addEventListener('click', async () => {
                console.log("Add task button clicked!"); // Debugging log
                const text = newTaskInput.value.trim();
                const subject = newSubjectInput.value.trim();
                const doDate = newDoDateInput.value; // Get "When to do" date
                const doTime = newDoTimeInput.value; // Get "When to do" time
                const submissionDate = newSubmissionDateInput.value; // Get "When to submit" date

                console.log("Add Task Data:", { text, subject, doDate, doTime, submissionDate });
                console.log("Firebase State before addDoc:", "db:", db, "currentUserId:", currentUserId, "isAuthReady:", isAuthReady);


                // Validate input and Firebase readiness
                if (text === '' || !db || !currentUserId || !isAuthReady) {
                    console.warn("Cannot add task: text is empty, or Firebase/user is not ready. DB:", db, "User ID:", currentUserId, "Auth Ready:", isAuthReady); // More detailed log
                    // Optionally, show a user-friendly message here instead of just console.warn
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${__app_id}/users/${currentUserId}/tasks`), {
                        text: text,
                        subject: subject,
                        doDate: doDate, // Save "When to do" date
                        doTime: doTime, // Save "When to do" time
                        submissionDate: submissionDate, // Save "When to submit" date
                        completed: false,
                        timestamp: Date.now()
                    });
                    console.log("Task added successfully!");
                    // Clear input fields
                    newTaskInput.value = '';
                    newSubjectInput.value = '';
                    newDoDateInput.value = '';
                    newDoTimeInput.value = '';
                    newSubmissionDateInput.value = '';
                } catch (e) {
                    console.error("Error adding document to Firestore: ", e);
                }
            });

            // Event listeners for adding task with Enter key press on input fields
            newTaskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
            newSubjectInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
            newDoDateInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
            newDoTimeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
            newSubmissionDateInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
        }


        /**
         * Updates the text and styling of the notification permission button
         * based on the current notification permission status.
         */
        function updateNotificationButtonState() {
            if (notificationPermission === "granted") {
                requestNotificationPermissionBtn.textContent = '转专转 驻注转';
                requestNotificationPermissionBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500', 'bg-blue-600', 'hover:bg-blue-700');
                requestNotificationPermissionBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                requestNotificationPermissionBtn.disabled = true; // Disable if permission is granted
            } else if (notificationPermission === "denied") {
                requestNotificationPermissionBtn.textContent = '转专转 住转';
                requestNotificationPermissionBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-500', 'hover:bg-green-600');
                requestNotificationPermissionBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
                requestNotificationPermissionBtn.disabled = true; // Disable if permission is denied
            } else {
                requestNotificationPermissionBtn.textContent = '驻注 转专转';
                requestNotificationPermissionBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500', 'bg-green-500', 'hover:bg-green-600');
                requestNotificationPermissionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                requestNotificationPermissionBtn.disabled = false; // Enable if permission is default/not granted
            }
        }

        /**
         * Requests notification permission from the user.
         * Updates the button state and shows a confirmation notification if granted.
         */
        requestNotificationPermissionBtn.addEventListener('click', () => {
            // Check if Notification API is supported by the browser
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notification.");
                return;
            }

            // Request permission
            Notification.requestPermission().then(permission => {
                notificationPermission = permission; // Update global permission state
                updateNotificationButtonState(); // Update UI
                if (permission === "granted") {
                    console.log("Notification permission granted.");
                    // Show a welcome notification
                    new Notification("转专转 驻注转!", {
                        body: "注砖 转拽 转专转 注 砖转 转拽专转.",
                        icon: "https://placehold.co/48x48/000000/FFFFFF?text=" // Placeholder icon
                    });
                } else {
                    console.log("Notification permission denied.");
                }
            });
        });

        /**
         * Sets up a real-time listener for tasks from Firestore.
         * Fetches, sorts, renders tasks, and checks for daily notifications.
         */
        function listenForTasks() {
            // Ensure Firebase and user are ready before attempting to fetch tasks
            if (!db || !currentUserId || !isAuthReady) {
                console.log("Firestore or user not ready yet for listening to tasks. Retrying...");
                setTimeout(listenForTasks, 1000); // Retry after 1 second
                return;
            }
            console.log("listenForTasks: Starting Firestore listener for user:", currentUserId);

            // Define the Firestore collection path for the current user's tasks
            const tasksCollectionRef = collection(db, `artifacts/${__app_id}/users/${currentUserId}/tasks`);
            const q = query(tasksCollectionRef); // No orderBy in query to avoid index issues; sorting done client-side

            // Set up a real-time snapshot listener
            onSnapshot(q, (snapshot) => {
                console.log("Firestore Snapshot received. Number of docs:", snapshot.docs.length);
                // Map Firestore documents to a cleaner array of task objects
                const fetchedTasks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Sort tasks: first by submissionDate (earliest), then by doDate (earliest), then by timestamp (newest)
                fetchedTasks.sort((a, b) => {
                    const submissionDateA = a.submissionDate ? new Date(a.submissionDate).getTime() : Infinity;
                    const submissionDateB = b.submissionDate ? new Date(b.submissionDate).getTime() : Infinity;

                    if (submissionDateA !== submissionDateB) {
                        return submissionDateA - submissionDateB; // Sort by submission date
                    }

                    const doDateTimeA = (a.doDate && a.doTime) ? new Date(`${a.doDate}T${a.doTime}`).getTime() : Infinity;
                    const doDateTimeB = (b.doDate && b.doTime) ? new Date(`${b.doDate}T${b.doTime}`).getTime() : Infinity;

                    if (doDateTimeA !== doDateTimeB) {
                        return doDateTimeA - doDateTimeB; // Sort by do date and time
                    }
                    
                    return (b.timestamp || 0) - (a.timestamp || 0); // Then by timestamp (newest first)
                });

                renderTasks(fetchedTasks); // Render the sorted tasks to the DOM
                checkForNotifications(fetchedTasks); // Check for and display notifications for today's tasks
            }, (error) => {
                console.error("Error fetching tasks from Firestore:", error);
            });
        }

        /**
         * Renders the given array of tasks to the DOM.
         * Clears existing tasks and appends new ones.
         * Displays a message if there are no tasks.
         * @param {Array<Object>} tasks - An array of task objects to render.
         */
        function renderTasks(tasks) {
            taskList.innerHTML = ''; // Clear existing tasks from the list
            if (tasks.length === 0) {
                noTasksMessage.classList.remove('hidden'); // Show "No tasks" message
            } else {
                noTasksMessage.classList.add('hidden'); // Hide "No tasks" message
                tasks.forEach(task => {
                    const listItem = document.createElement('li');
                    listItem.className = `flex flex-col sm:flex-row sm:items-center bg-gray-50 p-4 rounded-lg shadow-sm transition duration-200 ease-in-out hover:shadow-md`;

                    // Create and append checkbox for task completion
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = task.completed;
                    checkbox.className = 'form-checkbox h-6 w-6 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500 cursor-pointer';
                    checkbox.addEventListener('change', () => toggleTaskCompletion(task.id, task.completed));

                    // Create container for task details (text, subject, do date/time, submission date)
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'ml-4 text-lg text-gray-800 flex-grow mb-2 sm:mb-0';

                    const taskTextSpan = document.createElement('span');
                    taskTextSpan.textContent = task.text;
                    if (task.completed) {
                        taskTextSpan.classList.add('line-through', 'text-gray-500'); // Apply strikethrough if completed
                    }
                    detailsDiv.appendChild(taskTextSpan);

                    // Add subject if available
                    if (task.subject) {
                        const subjectP = document.createElement('p');
                        subjectP.className = 'text-sm text-gray-600 mt-1';
                        subjectP.innerHTML = `<span class="font-semibold">拽爪注:</span> ${task.subject}`;
                        detailsDiv.appendChild(subjectP);
                    }

                    // Add "When to do" date and time if available
                    if (task.doDate || task.doTime) {
                        const doDateTimeP = document.createElement('p');
                        doDateTimeP.className = 'text-sm text-gray-600';
                        doDateTimeP.innerHTML = `<span class="font-semibold">转 注砖转:</span> ${formatDate(task.doDate)} ${task.doTime || ''}`;
                        detailsDiv.appendChild(doDateTimeP);
                    }

                    // Add "When to submit" date if available (renamed from dueDate)
                    if (task.submissionDate) {
                        const submissionDateP = document.createElement('p');
                        submissionDateP.className = 'text-sm text-gray-600';
                        submissionDateP.innerHTML = `<span class="font-semibold">转 爪专 砖:</span> ${formatDate(task.submissionDate)}`;
                        detailsDiv.appendChild(submissionDateP);
                    }

                    // Create and append delete button
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'ml-auto p-2 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-110';
                    deleteButton.setAttribute('aria-label', '拽 砖');
                    // SVG icon for delete button
                    deleteButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1  0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clipRule="evenodd" />
                        </svg>
                    `;
                    deleteButton.addEventListener('click', () => deleteTask(task.id));

                    // Append all elements to the list item
                    listItem.appendChild(checkbox);
                    listItem.appendChild(detailsDiv);
                    listItem.appendChild(deleteButton);
                    taskList.appendChild(listItem);
                });
            }
        }

        /**
         * Toggles the completion status of a task in Firestore.
         * @param {string} id - The ID of the task document in Firestore.
         * @param {boolean} completed - The current completion status of the task.
         */
        async function toggleTaskCompletion(id, completed) {
            if (!db || !currentUserId) {
                console.warn("Cannot toggle task completion: Firebase/user not ready.");
                return;
            }
            try {
                const taskRef = doc(db, `artifacts/${__app_id}/users/${currentUserId}/tasks`, id);
                await updateDoc(taskRef, {
                    completed: !completed // Toggle the boolean value
                });
            } catch (e) {
                    console.error("Error updating document in Firestore: ", e);
            }
        }

        /**
         * Deletes a task from Firestore.
         * @param {string} id - The ID of the task document to delete.
         */
        async function deleteTask(id) {
            if (!db || !currentUserId) {
                console.warn("Cannot delete task: Firebase/user not ready.");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${__app_id}/users/${currentUserId}/tasks`, id));
            } catch (e) {
                console.error("Error deleting document from Firestore: ", e);
            }
        }

        /**
         * Formats a date string into a localized Hebrew date format (e.g., DD.MM.YYYY).
         * @param {string} dateString - The date string to format (e.g., "YYYY-MM-DD").
         * @returns {string} The formatted date string or ' 转专' if empty.
         */
        function formatDate(dateString) {
            if (!dateString) return ' 转专';
            const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('he-IL', options);
        }

        /**
         * Checks the provided list of tasks for any uncompleted tasks due today.
         * If found and notification permission is granted, it sends a desktop notification.
         * Limits notifications to once per day using localStorage.
         * @param {Array<Object>} tasks - The list of tasks to check.
         */
        function checkForNotifications(tasks) {
            if (notificationPermission === "granted") {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

                const lastNotificationDate = localStorage.getItem(NOTIFICATION_LAST_SENT_KEY);
                const lastNotifiedDay = lastNotificationDate ? new Date(lastNotificationDate) : null;
                lastNotifiedDay?.setHours(0, 0, 0, 0); // Normalize last notified date

                // Only send notification if it hasn't been sent today
                if (!lastNotifiedDay || lastNotifiedDay.getTime() !== today.getTime()) {
                    const upcomingTasks = tasks.filter(task => {
                        // Filter for uncompleted tasks with a submissionDate that is today
                        if (!task.submissionDate || task.completed) return false;
                        const taskSubmissionDate = new Date(task.submissionDate);
                        taskSubmissionDate.setHours(0, 0, 0, 0); // Normalize task submission date

                        return taskSubmissionDate.getTime() === today.getTime();
                    });

                    if (upcomingTasks.length > 0) {
                        // Construct the notification message
                        const notificationMessage = `砖  ${upcomingTasks.length} 砖转 :\n` +
                                                    upcomingTasks.map(t => `${t.subject ? t.subject + ': ' : ''}${t.text}`).join('\n');

                        // Create and display the notification
                        new Notification("砖转 拽专转!", {
                            body: notificationMessage,
                            icon: "https://placehold.co/48x48/000000/FFFFFF?text=" // Placeholder icon
                        });
                        // Store today's date to prevent repeated notifications
                        localStorage.setItem(NOTIFICATION_LAST_SENT_KEY, today.toISOString());
                    }
                }
            }
        }

        // Register the Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // IMPORTANT: Update /your-repo-name/ to your actual GitHub Pages repository name
                navigator.serviceWorker.register('/your-repo-name/service-worker.js', { scope: '/your-repo-name/' })
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // Initialize Firebase and the app when the window has fully loaded
        window.onload = initializeFirebase;
    </script>
	<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDyihBq8d-Xa_2kxazwd7bOY84b241ePW0",
    authDomain: "school-work-20dd9.firebaseapp.com",
    projectId: "school-work-20dd9",
    storageBucket: "school-work-20dd9.firebasestorage.app",
    messagingSenderId: "28252809647",
    appId: "1:28252809647:web:06a9be297f28c2dbaf675a"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
</body>
</html>
