<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Default: Light Mode styles */
            background-color: #e0e7ff; /* Light blue-violet for background */
            color: #1f2937; /* Default text color */
        }

        /* Dark Mode styles */
        .dark body {
            background-color: #000000; /* Really black background */
            color: #e2e8f0; /* Light text color */
        }

        .dark .bg-white {
            background-color: #2d3748; /* Darker card background */
            color: #e2e8f0;
        }

        .dark .text-gray-800 {
            color: #e2e8f0;
        }

        .dark .text-gray-600 {
            color: #a0aec0;
        }

        .dark .border-gray-300 {
            border-color: #4a5568;
        }

        .dark .bg-gray-50 {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        .dark .text-gray-500 {
            color: #a0aec0;
        }

        .dark .task-text {
            color: #e2e8f0;
        }
        .dark .task-text.line-through {
            color: #a0aec0;
        }

        .dark .calendar-day-header {
            background-color: #4a5568; /* Darker header background */
            color: #e2e8f0;
        }

        .dark .calendar-task-item {
            background-color: #2d3748; /* Darker item background */
            color: #e2e8f0;
        }

        .dark .calendar-task-item.completed .task-text {
            color: #a0aec0;
        }

        .dark .form-checkbox {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        
        .dark #userIdDisplay {
            color: #a0aec0;
        }
        .dark #userIdDisplay span {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        /* General styles for calendar for both modes */
        .calendar-day-header {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            font-weight: bold;
            text-align: center;
        }
        .calendar-task-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="School Tasks">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/000000/FFFFFF?text=PWA">
    <link rel="apple-touch-startup-image" href="https://placehold.co/1125x2436/000000/FFFFFF?text=Loading">

    <link rel="manifest" href="/school-list/manifest.json">
</head>
<body class="min-h-screen flex items-center justify-center p-4 transition-colors duration-300 ease-in-out">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-auto transition-colors duration-300 ease-in-out">
        <h1 class="text-4xl font-extrabold mb-6 text-center">
            School Tasks
        </h1>

        <div id="userIdDisplay" class="text-sm mb-4 text-center break-all">
            </div>

        <button id="toggleDarkModeBtn"
            class="w-full py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 mb-4
            bg-gray-400 hover:bg-gray-500 text-white font-bold">
            Toggle Dark Mode
        </button>

        <button id="requestNotificationPermissionBtn"
            class="w-full py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 mb-4
            bg-gray-400 hover:bg-gray-500 text-white font-bold">
            Enable Notifications
        </button>

        <div class="flex justify-center gap-4 mb-6">
            <button id="showListViewBtn"
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Show List
            </button>
            <button id="showCalendarViewBtn"
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Show Calendar
            </button>
        </div>

        <div class="flex flex-col gap-3 mb-6">
            <input type="text" id="newTaskInput"
                class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                placeholder="Task description..." />
            <input type="text" id="newSubjectInput"
                class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                placeholder="Subject (e.g., Math)" />
            
            <label for="newDoDateInput" class="text-sm -mb-2">Do Date:</label>
            <input type="date" id="newDoDateInput"
                class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            
            <label for="newDoTimeInput" class="text-sm -mb-2">Do Time:</label>
            <input type="time" id="newDoTimeInput"
                class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />

            <label for="newSubmissionDateInput" class="text-sm -mb-2">Submission Date:</label>
            <input type="date" id="newSubmissionDateInput"
                class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            
            <button id="addTaskBtn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Add Task
            </button>
        </div>

        <div id="listViewSection">
            <ul id="taskList" class="space-y-4">
            </ul>
            <p id="noTasksMessage" class="text-center text-lg mt-4 hidden">No tasks yet!</p>
        </div>

        <div id="calendarViewSection" class="hidden">
            <div id="calendarNavigation" class="flex justify-between items-center mb-4">
                <button id="prevWeekBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                    Previous Week
                </button>
                <span id="currentWeekRange" class="text-lg font-semibold"></span>
                <button id="nextWeekBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                    Next Week
                </button>
            </div>
            <div id="calendarContent" class="space-y-4">
                </div>
            <p id="noCalendarTasksMessage" class="text-center text-lg mt-4 hidden">No scheduled tasks for this week!</p>
        </div>
    </div>

    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and application state
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        let notificationPermission = "default"; // Initial state for notification permission
        const NOTIFICATION_LAST_SENT_KEY = 'lastNotificationDate'; // Key for localStorage to prevent daily spamming of notifications
        let currentTasks = []; // Store the fetched tasks globally
        let areListenersAttached = false; // Flag to prevent duplicate event listeners

        // Calendar specific global variable
        let currentCalendarWeekStart = new Date(); // Start of the current week displayed in calendar

        // Get DOM elements for interaction
        const newTaskInput = document.getElementById('newTaskInput');
        const newSubjectInput = document.getElementById('newSubjectInput');
        const newDoDateInput = document.getElementById('newDoDateInput');
        const newDoTimeInput = document.getElementById('newDoTimeInput');
        const newSubmissionDateInput = document.getElementById('newSubmissionDateInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskList = document.getElementById('taskList');
        const noTasksMessage = document.getElementById('noTasksMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const requestNotificationPermissionBtn = document.getElementById('requestNotificationPermissionBtn');

        // View management elements
        const showListViewBtn = document.getElementById('showListViewBtn');
        const showCalendarViewBtn = document.getElementById('showCalendarViewBtn');
        const listViewSection = document.getElementById('listViewSection');
        const calendarViewSection = document.getElementById('calendarViewSection');
        const calendarContent = document.getElementById('calendarContent');
        const noCalendarTasksMessage = document.getElementById('noCalendarTasksMessage');

        // Calendar navigation elements
        const calendarNavigation = document.getElementById('calendarNavigation');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const currentWeekRange = document.getElementById('currentWeekRange');

        // Dark Mode elements
        const toggleDarkModeBtn = document.getElementById('toggleDarkModeBtn');
        const htmlElement = document.documentElement; // The <html> element

        let currentView = 'list'; // 'list' or 'calendar'

        /**
         * Initializes Firebase application and authentication.
         * Sets up an authentication state listener to handle user sign-in.
         */
        async function initializeFirebase() {
            try {
                // FIXED: Ensure these Firebase config values are correct from your Firebase Project Settings.
                // Based on your previous screenshots, these values seem correct for project "school-work-20dd9".
                const firebaseConfig = {
                    apiKey: "AIzaSyDyihBq8d-Xa_2kxazwd7bOY84b241ePW0", // Your actual API Key
                    authDomain: "school-work-20dd9.firebaseapp.com",
                    projectId: "school-work-20dd9",
                    storageBucket: "school-work-20dd9.firebasestorage.app",
                    messagingSenderId: "28252809647",
                    appId: "1:28252809647:web:c7cc264f99a06cf3af675a"
                };

                console.log("Firebase initialization: Starting...");
                console.log("Firebase config:", firebaseConfig);

                // Added a check to prevent initialization with invalid config, though unlikely with hardcoded.
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    console.error("Firebase config is missing or empty or API Key is not set.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase initialization: App, DB, Auth initialized.");

                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state changed. User:", user);
                    if (!user) {
                        try {
                            console.log("Auth state changed: Attempting anonymous sign-in.");
                            await signInAnonymously(auth);
                            console.log("Auth state changed: Anonymous sign-in completed.");
                        } catch (error) {
                            // FIXED: More specific error logging for auth issues.
                            console.error("Error during Firebase anonymous sign-in. Check Firebase project config (Authentication -> Sign-in method -> Anonymous) and rules:", error);
                        }
                    }
                    // FIXED: Ensure currentUserId is correctly set even if anonymous sign-in fails
                    currentUserId = auth.currentUser?.uid || crypto.randomUUID(); // Fallback to random ID if no user
                    userIdDisplay.innerHTML = `User ID: <span class="font-mono bg-gray-100 p-1 rounded dark:bg-gray-700">${currentUserId}</span>`;
                    isAuthReady = true;
                    console.log("Auth state changed: Current User ID set to", currentUserId, "isAuthReady:", isAuthReady);

                    // Only proceed if a user ID is available (either authenticated or random fallback)
                    if (currentUserId) {
                        listenForTasks(); // Start listening for tasks once authenticated (or ID available)
                        setupAddTaskListeners(); // Attach listeners only once
                    } else {
                        console.error("No valid user ID could be established. Cannot listen for tasks or add tasks.");
                    }
                });

                if ("Notification" in window) {
                    notificationPermission = Notification.permission;
                    updateNotificationButtonState();
                }

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
            }
        }

        /**
         * Sets up event listeners for adding tasks.
         * This function is called only once after Firebase authentication is ready.
         */
        function setupAddTaskListeners() {
            if (areListenersAttached) {
                console.log("Add task listeners already attached, skipping duplicate attachment.");
                return;
            }
            console.log("setupAddTaskListeners: Attaching event listeners.");
            addTaskBtn.addEventListener('click', async () => {
                console.log("Add Task button clicked!");
                const text = newTaskInput.value.trim();
                const subject = newSubjectInput.value.trim();
                const doDate = newDoDateInput.value;
                const doTime = newDoTimeInput.value;
                const submissionDate = newSubmissionDateInput.value;

                console.log("Task input data:", { text, subject, doDate, doTime, submissionDate });
                console.log("Firebase state before addDoc:", "db:", db, "currentUserId:", currentUserId, "isAuthReady:", isAuthReady);

                // FIXED: Ensure all necessary data and Firebase is ready.
                if (text === '' || !db || !currentUserId || !isAuthReady) {
                    console.warn("Cannot add task: Text is empty, or Firebase/user is not ready. DB:", db, "User ID:", currentUserId, "Auth Ready:", isAuthReady);
                    // Added a check specifically for Firestore instance
                    if (!db) console.error("Firestore DB instance is not initialized.");
                    if (!currentUserId) console.error("currentUserId is not set.");
                    if (!isAuthReady) console.error("Firebase auth state is not ready.");
                    return;
                }

                try {
                    const projectIdForPath = auth.app.options.projectId; 
                    await addDoc(collection(db, `artifacts/${projectIdForPath}/users/${currentUserId}/tasks`), {
                        text: text,
                        subject: subject,
                        doDate: doDate,
                        doTime: doTime,
                        submissionDate: submissionDate,
                        completed: false,
                        timestamp: Date.now()
                    });
                    console.log("Task added successfully!");
                    newTaskInput.value = '';
                    newSubjectInput.value = '';
                    newDoDateInput.value = '';
                    newDoTimeInput.value = '';
                    newSubmissionDateInput.value = '';
                } catch (e) {
                    console.error("Error adding document to Firestore: ", e);
                    console.error("Possible cause: Firestore security rules preventing write access. Check your Firebase console.");
                }
            });

            newTaskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
            newSubjectInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
            newDoDateInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
            newDoTimeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });
            newSubmissionDateInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTaskBtn.click();
            });

            areListenersAttached = true; // Set the flag after attaching listeners
        }

        /**
         * Updates the text and styling of the notification permission button
         * based on the current notification permission status.
         */
        function updateNotificationButtonState() {
            if (notificationPermission === "granted") {
                requestNotificationPermissionBtn.textContent = 'Notifications Enabled';
                requestNotificationPermissionBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500', 'bg-blue-600', 'hover:bg-blue-700');
                requestNotificationPermissionBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                requestNotificationPermissionBtn.disabled = true;
            } else if (notificationPermission === "denied") {
                requestNotificationPermissionBtn.textContent = 'Notifications Blocked';
                requestNotificationPermissionBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-500', 'hover:bg-green-600');
                requestNotificationPermissionBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
                requestNotificationPermissionBtn.disabled = true;
            } else {
                requestNotificationPermissionBtn.textContent = 'Enable Notifications';
                requestNotificationPermissionBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500', 'bg-green-500', 'hover:bg-green-600');
                requestNotificationPermissionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                requestNotificationPermissionBtn.disabled = false;
            }
        }

        /**
         * Requests notification permission from the user.
         * Updates the button state and shows a confirmation notification if granted.
         */
        requestNotificationPermissionBtn.addEventListener('click', () => {
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notifications.");
                return;
            }

            Notification.requestPermission().then(permission => {
                notificationPermission = permission;
                updateNotificationButtonState();
                if (permission === "granted") {
                    console.log("Notification permission granted.");
                    // No direct notification here, service worker will handle it
                } else {
                    console.log("Notification permission denied.");
                }
            });
        });

        /**
         * Sends a notification message to the service worker.
         * @param {string} title - The title of the notification.
         * @param {string} body - The body text of the notification.
         * @param {string} icon - The URL for the notification icon.
         */
        function sendNotificationToServiceWorker(title, body, icon) {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'SHOW_NOTIFICATION',
                    title: title,
                    body: body,
                    icon: icon
                });
                console.log("Notification message sent to service worker.");
            } else {
                console.warn("Service Worker not active or not supported, cannot send notification message.");
                // Fallback to direct notification if service worker isn't available/active
                if (Notification.permission === "granted") {
                    new Notification(title, { body: body, icon: icon });
                }
            }
        }

        /**
         * Sets up a real-time listener for tasks from Firestore.
         * Fetches, sorts, renders tasks, and checks for daily notifications.
         */
        function listenForTasks() {
            // FIXED: Added a check for currentUserId here, as it might be null initially if auth fails.
            if (!db || !currentUserId || !isAuthReady) {
                console.log("Firestore or user not ready to listen for tasks. Retrying in 1 second...");
                setTimeout(listenForTasks, 1000);
                return;
            }
            console.log("listenForTasks: Activating Firestore listener for user:", currentUserId);

            const projectIdForPath = auth.app.options.projectId;
            const tasksCollectionRef = collection(db, `artifacts/${projectIdForPath}/users/${currentUserId}/tasks`);
            const q = query(tasksCollectionRef);

            onSnapshot(q, (snapshot) => {
                console.log("Firestore snapshot received. Number of documents:", snapshot.docs.length);
                const fetchedTasks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Update the global tasks array
                currentTasks = fetchedTasks;

                // Render tasks based on the current view
                toggleView(); // Call toggleView to ensure correct rendering based on currentView
                
                checkForNotifications(currentTasks);
            }, (error) => {
                console.error("Error fetching tasks from Firestore:", error);
                console.error("Possible cause: Firestore security rules preventing read access. Check your Firebase console.");
            });
        }

        /**
         * Renders the given array of tasks to the DOM in a list format.
         * Clears existing tasks and appends new ones.
         * Displays a message if there are no tasks.
         * @param {Array<Object>} tasks - An array of task objects to render.
         */
        function renderListView(tasksToRender) {
            // Sort tasks for list view (submission date, then do date, then timestamp)
            tasksToRender.sort((a, b) => {
                const submissionDateA = a.submissionDate ? new Date(a.submissionDate).getTime() : Infinity;
                const submissionDateB = b.submissionDate ? new Date(b.submissionDate).getTime() : Infinity;

                if (submissionDateA !== submissionDateB) {
                    return submissionDateA - submissionDateB;
                }

                const doDateTimeA = (a.doDate && a.doTime) ? new Date(`${a.doDate}T${a.doTime}`).getTime() : Infinity;
                const doDateTimeB = (b.doDate && b.doTime) ? new Date(`${b.doDate}T${b.doTime}`).getTime() : Infinity;

                if (doDateTimeA !== doDateTimeB) {
                    return doDateTimeA - doDateTimeB;
                }
                
                return (b.timestamp || 0) - (a.timestamp || 0);
            });

            taskList.innerHTML = ''; // Clear existing tasks from the list
            if (tasksToRender.length === 0) {
                noTasksMessage.classList.remove('hidden');
            } else {
                noTasksMessage.classList.add('hidden');
                tasksToRender.forEach(task => {
                    const listItem = document.createElement('li');
                    listItem.className = `flex flex-col sm:flex-row sm:items-center bg-gray-50 p-4 rounded-lg shadow-sm transition-colors duration-200 ease-in-out hover:shadow-md dark:bg-gray-700`;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = task.completed;
                    checkbox.className = 'form-checkbox h-6 w-6 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500 cursor-pointer dark:border-gray-500';
                    checkbox.addEventListener('change', () => toggleTaskCompletion(task.id));

                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'ml-4 text-lg flex-grow mb-2 sm:mb-0';

                    const taskTextSpan = document.createElement('span');
                    taskTextSpan.textContent = task.text;
                    if (task.completed) {
                        taskTextSpan.classList.add('line-through', 'text-gray-500', 'dark:text-gray-400');
                    } else {
                        taskTextSpan.classList.add('text-gray-800', 'dark:text-white');
                    }
                    taskTextSpan.classList.add('task-text'); // Add a class for specific dark mode styling
                    detailsDiv.appendChild(taskTextSpan);

                    if (task.subject) {
                        const subjectP = document.createElement('p');
                        subjectP.className = 'text-sm text-gray-600 mt-1 dark:text-gray-400';
                        subjectP.innerHTML = `<span class="font-semibold">Subject:</span> ${task.subject}`;
                        detailsDiv.appendChild(subjectP);
                    }

                    if (task.doDate || task.doTime) {
                        const doDateTimeP = document.createElement('p');
                        doDateTimeP.className = 'text-sm text-gray-600 dark:text-gray-400';
                        doDateTimeP.innerHTML = `<span class="font-semibold">Do Date:</span> ${formatDate(task.doDate)} ${task.doTime || ''}`;
                        detailsDiv.appendChild(doDateTimeP);
                    }

                    if (task.submissionDate) {
                        const submissionDateP = document.createElement('p');
                        submissionDateP.className = 'text-sm text-gray-600 dark:text-gray-400';
                        submissionDateP.innerHTML = `<span class="font-semibold">Submission Date:</span> ${formatDate(task.submissionDate)}`;
                        detailsDiv.appendChild(submissionDateP);
                    }

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'ml-auto p-2 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-110';
                    deleteButton.setAttribute('aria-label', 'Delete task');
                    deleteButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1  0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clipRule="evenodd" />
                        </svg>
                    `;
                    deleteButton.addEventListener('click', () => deleteTask(task.id));

                    listItem.appendChild(checkbox);
                    listItem.appendChild(detailsDiv);
                    listItem.appendChild(deleteButton);
                    taskList.appendChild(listItem);
                });
            }
        }

        /**
         * Renders the given array of tasks to the DOM in a calendar/grouped by date format.
         * Groups tasks by their doDate and submissionDate.
         * @param {Array<Object>} tasks - An array of task objects to render.
         */
        function renderCalendarView(tasksToRender) {
            calendarContent.innerHTML = ''; // Clear existing calendar content
            const groupedTasks = {}; // Object to store tasks grouped by date

            // Normalize currentCalendarWeekStart to the beginning of its week (Sunday)
            const startOfWeek = new Date(currentCalendarWeekStart);
            startOfWeek.setHours(0, 0, 0, 0);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay()); // Go to Sunday (0 for Sunday, 1 for Monday, etc.)

            // Set the current week range text
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6); // Go to Saturday
            currentWeekRange.textContent = `${formatDate(startOfWeek.toISOString().split('T')[0])} - ${formatDate(endOfWeek.toISOString().split('T')[0])}`;

            // Initialize days of the week in groupedTasks
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateKey = day.toISOString().split('T')[0];
                groupedTasks[dateKey] = [];
            }

            // Group tasks by relevant dates within the current week
            tasksToRender.forEach(task => {
                // Add to 'doDate' group
                if (task.doDate) {
                    const doDateObj = new Date(task.doDate + 'T00:00:00');
                    doDateObj.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
                    if (doDateObj >= startOfWeek && doDateObj <= endOfWeek) {
                        const dateKey = doDateObj.toISOString().split('T')[0];
                        if (groupedTasks[dateKey]) { // Ensure the day is part of the current week's initialized days
                            groupedTasks[dateKey].push({ ...task, eventType: 'To Do' }); // Mark as 'To Do'
                        }
                    }
                }
                // Add to 'submissionDate' group
                if (task.submissionDate) {
                    const submissionDateObj = new Date(task.submissionDate + 'T00:00:00');
                    submissionDateObj.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
                    if (submissionDateObj >= startOfWeek && submissionDateObj <= endOfWeek) {
                        const dateKey = submissionDateObj.toISOString().split('T')[0];
                        // Avoid adding the same task twice to the same day if doDate and submissionDate are the same
                        const alreadyAdded = groupedTasks[dateKey]?.some(t => t.id === task.id && t.eventType === 'Submission');
                        if (groupedTasks[dateKey] && !alreadyAdded) {
                            groupedTasks[dateKey].push({ ...task, eventType: 'Submission' }); // Mark as 'Submission'
                        }
                    }
                }
            });

            let hasTasksInCalendar = false;
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateKey = day.toISOString().split('T')[0];
                const tasksForDay = groupedTasks[dateKey];

                const dateHeader = document.createElement('div');
                dateHeader.className = 'calendar-day-header';
                const displayDate = day.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                dateHeader.textContent = displayDate;
                calendarContent.appendChild(dateHeader);

                if (tasksForDay && tasksForDay.length > 0) {
                    hasTasksInCalendar = true;
                    // Sort tasks within each day: completed tasks last, then by time, then by eventType, then by timestamp
                    tasksForDay.sort((a, b) => {
                        if (a.completed && !b.completed) return 1;
                        if (!a.completed && b.completed) return -1;

                        const timeA = a.doTime ? new Date(`1970-01-01T${a.doTime}`).getTime() : 0;
                        const timeB = b.doTime ? new Date(`1970-01-01T${b.doTime}`).getTime() : 0;
                        if (timeA !== timeB) return timeA - timeB;

                        // Sort by event type: 'To Do' before 'Submission'
                        if (a.eventType === 'To Do' && b.eventType === 'Submission') return -1;
                        if (a.eventType === 'Submission' && b.eventType === 'To Do') return 1;
                        
                        return (b.timestamp || 0) - (a.timestamp || 0);
                    });

                    const tasksListForDay = document.createElement('div');
                    tasksListForDay.className = 'mt-2 space-y-2'; // Tailwind for vertical spacing
                    
                    tasksForDay.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `calendar-task-item ${task.completed ? 'completed' : ''}`;

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = task.completed;
                        checkbox.className = 'form-checkbox h-5 w-5 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500 cursor-pointer flex-shrink-0 dark:border-gray-500';
                        checkbox.addEventListener('change', () => toggleTaskCompletion(task.id));

                        const taskDetails = document.createElement('div');
                        taskDetails.className = 'flex-grow mr-2';

                        const taskTextSpan = document.createElement('span');
                        taskTextSpan.className = 'task-text font-medium';
                        taskTextSpan.textContent = task.text;
                        taskDetails.appendChild(taskTextSpan);

                        const taskMeta = document.createElement('p');
                        taskMeta.className = 'text-sm text-gray-600 dark:text-gray-400';
                        let metaContent = '';
                        if (task.subject) {
                            metaContent += `Subject: ${task.subject}`;
                        }
                        if (task.doTime && task.eventType === 'To Do') { // Only show time for 'To Do' events
                            metaContent += (metaContent ? ' | ' : '') + `At: ${task.doTime}`;
                        }
                        metaContent += (metaContent ? ' | ' : '') + `**${task.eventType}**`; // Display event type
                        taskMeta.innerHTML = metaContent;
                        taskDetails.appendChild(taskMeta);

                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'ml-auto p-2 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-110 flex-shrink-0';
                        deleteButton.setAttribute('aria-label', 'Delete task');
                        deleteButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1  0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clipRule="evenodd" />
                            </svg>
                        `;
                        deleteButton.addEventListener('click', () => deleteTask(task.id));

                        taskItem.appendChild(checkbox);
                        taskItem.appendChild(taskDetails);
                        taskItem.appendChild(deleteButton);
                        tasksListForDay.appendChild(taskItem);
                    });
                    calendarContent.appendChild(tasksListForDay);
                } else {
                    // If no tasks for the day, display a message within the day's section
                    const noTasksDayMessage = document.createElement('p');
                    noTasksDayMessage.className = 'text-center text-gray-400 text-sm mt-2 dark:text-gray-500';
                    noTasksDayMessage.textContent = 'No tasks for this day.';
                    calendarContent.appendChild(noTasksDayMessage);
                }
            }

            if (!hasTasksInCalendar) {
                noCalendarTasksMessage.classList.remove('hidden');
            } else {
                noCalendarTasksMessage.classList.add('hidden');
            }
        }

        /**
         * Navigates the calendar view by a week.
         * @param {number} direction - -1 for previous week, 1 for next week.
         */
        function navigateWeek(direction) {
            const newDate = new Date(currentCalendarWeekStart);
            newDate.setDate(newDate.getDate() + (direction * 7));
            currentCalendarWeekStart = newDate;
            renderCalendarView(currentTasks); // Re-render calendar with new week
        }

        // Event listeners for calendar navigation
        prevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        nextWeekBtn.addEventListener('click', () => navigateWeek(1));

        /**
         * Toggles the completion status of a task in Firestore.
         * @param {string} id - The ID of the task document in Firestore.
         */
        async function toggleTaskCompletion(id) {
            if (!db || !currentUserId) {
                console.warn("Cannot toggle task: Firebase/user not ready.");
                return;
            }
            try {
                const projectIdForPath = auth.app.options.projectId;
                const taskRef = doc(db, `artifacts/${projectIdForPath}/users/${currentUserId}/tasks`, id);
                // Find the task in currentTasks to get its current completed status
                const taskToToggle = currentTasks.find(task => task.id === id);
                if (taskToToggle) {
                    await updateDoc(taskRef, {
                        completed: !taskToToggle.completed // Toggle the status
                    });
                }
            } catch (e) {
                console.error("Error updating document in Firestore: ", e);
                console.error("Possible cause: Firestore security rules preventing write access. Check your Firebase console.");
            }
        }

        /**
         * Deletes a task from Firestore.
         * @param {string} id - The ID of the task document to delete.
         */
        async function deleteTask(id) {
            if (!db || !currentUserId) {
                console.warn("Cannot delete task: Firebase/user not ready.");
                return;
            }
            try {
                const projectIdForPath = auth.app.options.projectId;
                await deleteDoc(doc(db, `artifacts/${projectIdForPath}/users/${currentUserId}/tasks`, id));
            } catch (e) {
                console.error("Error deleting document from Firestore: ", e);
                console.error("Possible cause: Firestore security rules preventing delete access. Check your Firebase console.");
            }
        }

        /**
         * Formats a date string into a localized English date format (e.g., MM/DD/YYYY).
         * @param {string} dateString - The date string to format (e.g., "YYYY-MM-DD").
         * @returns {string} The formatted date string or 'No date' if empty.
         */
        function formatDate(dateString) {
            if (!dateString) return 'No date';
            const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
            return new Date(dateString + 'T00:00:00').toLocaleDateString('en-US', options); // Add T00:00:00 to avoid timezone issues
        }

        /**
         * Checks the provided list of tasks for any uncompleted tasks due today.
         * If found and notification permission is granted, it sends a desktop notification.
         * Limits notifications to once per day using localStorage.
         * @param {Array<Object>} tasks - The list of tasks to check.
         */
        function checkForNotifications(tasks) {
            if (notificationPermission === "granted") {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const lastNotificationDate = localStorage.getItem(NOTIFICATION_LAST_SENT_KEY);
                const lastNotifiedDay = lastNotificationDate ? new Date(lastNotificationDate) : null;
                lastNotifiedDay?.setHours(0, 0, 0, 0);

                // Only send notification if it hasn't been sent today
                if (!lastNotifiedDay || lastNotifiedDay.getTime() !== today.getTime()) {
                    const upcomingTasks = tasks.filter(task => {
                        // Trigger notification based on doDate, not submissionDate
                        if (!task.doDate || task.completed) return false;
                        const taskDoDate = new Date(task.doDate);
                        taskDoDate.setHours(0, 0, 0, 0);

                        return taskDoDate.getTime() === today.getTime();
                    });

                    if (upcomingTasks.length > 0) {
                        const notificationMessage = `You have ${upcomingTasks.length} tasks due today:\n` +
                                                    upcomingTasks.map(t => `${t.subject ? t.subject + ': ' : ''}${t.text}`).join('\n');

                        // Send notification message to Service Worker
                        sendNotificationToServiceWorker("Upcoming Tasks!", notificationMessage, "https://placehold.co/48x48/000000/FFFFFF?text=🔔");
                        localStorage.setItem(NOTIFICATION_LAST_SENT_KEY, today.toISOString());
                    }
                }
            }
        }

        // --- View Toggling Logic ---
        function toggleView() {
            if (currentView === 'list') {
                listViewSection.classList.remove('hidden');
                calendarViewSection.classList.add('hidden');
                showListViewBtn.classList.add('bg-purple-700'); // Highlight active button
                showListViewBtn.classList.remove('bg-purple-600');
                showCalendarViewBtn.classList.remove('bg-purple-700');
                showCalendarViewBtn.classList.add('bg-purple-600');
                calendarNavigation.classList.add('hidden'); // Hide calendar navigation
                renderListView(currentTasks);
            } else { // currentView === 'calendar'
                listViewSection.classList.add('hidden');
                calendarViewSection.classList.remove('hidden');
                showCalendarViewBtn.classList.add('bg-purple-700'); // Highlight active button
                showCalendarViewBtn.classList.remove('bg-purple-600');
                showListViewBtn.classList.remove('bg-purple-700');
                showListViewBtn.classList.add('bg-purple-600');
                calendarNavigation.classList.remove('hidden'); // Show calendar navigation
                renderCalendarView(currentTasks);
            }
        }

        showListViewBtn.addEventListener('click', () => {
            currentView = 'list';
            toggleView();
        });

        showCalendarViewBtn.addEventListener('click', () => {
            currentView = 'calendar';
            toggleView();
        });
        // --- End View Toggling Logic ---

        // --- Dark Mode Logic ---
        function applyDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
            if (isDarkMode) {
                htmlElement.classList.add('dark');
            } else {
                htmlElement.classList.remove('dark');
            }
        }

        toggleDarkModeBtn.addEventListener('click', () => {
            if (htmlElement.classList.contains('dark')) {
                htmlElement.classList.remove('dark');
                localStorage.setItem('darkMode', 'disabled');
            } else {
                htmlElement.classList.add('dark');
                localStorage.setItem('darkMode', 'enabled');
            }
        });
        // --- End Dark Mode Logic ---

        // Initial call to set the current week start to the beginning of the current week
        function setInitialCalendarWeek() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            currentCalendarWeekStart = new Date(today);
            currentCalendarWeekStart.setDate(today.getDate() - today.getDay()); // Go to Sunday (0 for Sunday)
        }

        // Register the Service Worker (PWA functionality)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // FIXED: Service Worker path for GitHub Pages deployment
                // Make sure service-worker.js is in the /school-list/ directory on your GitHub Pages repo
                navigator.serviceWorker.register('/school-list/service-worker.js', { scope: '/school-list/' })
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // Initialize Firebase and the app when the window has fully loaded
        window.onload = () => {
            applyDarkModePreference(); // Apply dark mode preference on load
            setInitialCalendarWeek(); // Set initial calendar week before Firebase init
            initializeFirebase();
            // The initial rendering will happen after Firebase fetches data via onSnapshot,
            // which calls toggleView().
        };
    </script>
</body>
</html>
